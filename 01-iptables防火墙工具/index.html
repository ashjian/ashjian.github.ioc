<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />




  


  <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml" />






<meta name="description" content="iptables： 包过滤型的防火墙Firewall：防火墙，隔离工具；工作于主机或网络边缘，对于进出本主机或本网络的报文根据事先定义的检查规则作匹配检测，对于能够被规则匹配到的报文作出相应处理的组件；  主机防火墙 ：针对本机  网络防火墙 ：针对局域网  软件防火墙（软件逻辑）  硬件防火墙（硬件和软件逻辑）：特殊设计的CPU，更加效率的指令集，在硬件层完成报文的拆封和封装 ipfw (fir">
<meta property="og:type" content="article">
<meta property="og:title" content="01-iptables防火墙工具">
<meta property="og:url" content="http://www.ashjian.xyz/01-iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name">
<meta property="og:description" content="iptables： 包过滤型的防火墙Firewall：防火墙，隔离工具；工作于主机或网络边缘，对于进出本主机或本网络的报文根据事先定义的检查规则作匹配检测，对于能够被规则匹配到的报文作出相应处理的组件；  主机防火墙 ：针对本机  网络防火墙 ：针对局域网  软件防火墙（软件逻辑）  硬件防火墙（硬件和软件逻辑）：特殊设计的CPU，更加效率的指令集，在硬件层完成报文的拆封和封装 ipfw (fir">
<meta property="og:image" content="https://raw.githubusercontent.com/ashjian/picBed/master/20201130150751.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ashjian/picBed/master/20201130150758.png">
<meta property="article:published_time" content="2020-11-30T09:29:19.000Z">
<meta property="article:modified_time" content="2020-11-30T09:29:19.657Z">
<meta property="article:author" content="ashjian">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="python">
<meta property="article:tag" content="运维">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ashjian/picBed/master/20201130150751.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.ashjian.xyz/01-iptables防火墙工具/"/>





  <title>01-iptables防火墙工具 | </title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d7bf52f45e24a0e6f2951901a7a97864";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title"></span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ashjian.xyz/01-iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ashjian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">01-iptables防火墙工具</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-30T17:29:19+08:00">
                2020-11-30
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-11-30T17:29:19+08:00">
                2020-11-30
              </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/01-iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%B7%A5%E5%85%B7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/01-iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%B7%A5%E5%85%B7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="iptables：-包过滤型的防火墙"><a href="#iptables：-包过滤型的防火墙" class="headerlink" title="iptables： 包过滤型的防火墙"></a>iptables： 包过滤型的防火墙</h2><p>Firewall：防火墙，隔离工具；工作于主机或网络边缘，对于进出本主机或本网络的报文根据事先定义的检查规则作匹配检测，对于能够被规则匹配到的报文作出相应处理的组件；</p>
<ul>
<li><p>主机防火墙 ：针对本机</p>
</li>
<li><p>网络防火墙 ：针对局域网</p>
</li>
<li><p>软件防火墙（软件逻辑）</p>
</li>
<li><p>硬件防火墙（硬件和软件逻辑）：特殊设计的CPU，更加效率的指令集，在硬件层完成报文的拆封和封装</p>
<p>ipfw (firewall framework)<br>ipchains (firewall framework)</p>
</li>
</ul>
<p>iptables(netfilter)<br>    netfilter：kernel 内核空间中真正对规则进行设置和管理的工具<br>    iptables：rules until 用户空间中，提供给用户系统调用netfilter的工具<br>nftables</p>
<p>hook function：在内核中，对报文进行检查过滤操作的五个位置<br>    prerouting        刚到防火墙服务器的报文，还没被路由时<br>    input             请求报文传送到本机<br>    output            本机进程发送响应报文到主机出门防火墙<br>    forward         请求报文传送到路由网关<br>    postrouting      经过output或者forward的报文再次经过路由出去本机后</p>
<p>链（内置）：每一个钩子hook都能放一堆规则，每个钩子的所有规则称为链<br>    PREROUTING<br>    INPUT<br>    FORWARD<br>    OUTPUT<br>    POSTROUTING</p>
<p>功能：<br>    filter：过滤，防火墙；<br>    nat：network address translation；用于修改源IP或目标IP，也可以改端口；主要目的用来内部主机<br>    mangle：拆解报文，做出修改，并重新封装起来；<br>    raw：关闭nat表上启用的连接追踪机制；<br>    每种功能在同一个链中，有执行顺序，相同功能连在一起执行，顺序为：<code>filter-nat-mangle-raw</code></p>
<p>功能&lt;–链：<br>    raw：PREROUTING， OUTPUT<br>    mangle：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING<br>    nat：PREROUTING，[INPUT，]OUTPUT，POSTROUTING<br>    filter：INPUT，FORWARD，OUTPUT（只在第一个路由和主机响应报文OUTPUT上做过滤）</p>
<p><img src="https://raw.githubusercontent.com/ashjian/picBed/master/20201130150751.png" alt="image-20200922153404635"></p>
<p><img src="https://raw.githubusercontent.com/ashjian/picBed/master/20201130150758.png" alt="功能在链上额工作顺序"></p>
<p>报文流向：<br>    流入本机：PREROUTING –&gt; INPUT<br>    由本机流出：OUTPUT –&gt; POSTROUTING<br>    转发：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
<p>路由功能发生的时刻：<br>    报文进入本机后：<br>        判断目标主机是？<br>    报文离开本机之前：<br>        判断经由哪个接口送往下一站？</p>
<p>iptables/netfilter</p>
<p>规则：<br>    组成部分：根据规则匹配条件来尝试匹配报文，一旦匹配成功，就由规则定义的处理动作作出处理；<br>        匹配条件：<br>            基本匹配条件：内建<br>            扩展匹配条件：由扩展模块定义；<br>        处理动作：<br>            基本处理动作：内建<br>            扩展处理动作：由扩展模块定义；<br>            自定义处理机制：自定义链</p>
<p>iptables的链：内置链和自定义链<br>    内置链：对应于hook function<br>    自定义链接：用于内置链的扩展和补充，可实现更灵活的规则管理机制；</p>
<p>添加规则时的考量点：<br>    (1) 要实现哪种功能：判断添加到哪个表上；<br>    (2) 报文流经的路径：判断添加到哪个链上；</p>
<p>链：链上的规则次序，即为检查的次序；因此，隐含一定的应用法则：<br>    (1) 同类规则（访问同一应用），匹配范围小的放上面；<br>    (2) 不同类的规则（访问不同应用），匹配到报文频率较大的放在上面；<br>    (3) 将那些可由一条规则描述的多个规则合并起来；<br>    (4) 设置默认策略；</p>
<h2 id="iptables命令："><a href="#iptables命令：" class="headerlink" title="iptables命令："></a>iptables命令：</h2><p>​    高度模块化，由诸多扩展模块实现其检查条件或处理动作的定义；<br>​        /usr/lib64/xtables/<br>​            IPv6：libip6t_<br>​            IPv4：libipt_  libxt_<br>​    </p>
<p>​       iptables [-t table] {-A|-C|-D} chain rule-specification</p>
<p>​        iptables [-t table] -I chain [rulenum] rule-specification</p>
<p>​        iptables [-t table] -R chain rulenum rule-specification</p>
<p>​        iptables [-t table] -D chain rulenum</p>
<p>​        iptables [-t table] -S [chain [rulenum]]</p>
<p>​        iptables [-t table] {-F|-L|-Z} [chain [rulenum]] [options…]</p>
<p>​        iptables [-t table] -N chain</p>
<p>​        iptables [-t table] -X  [chain]</p>
<p>​        iptables [-t table] -P chain target</p>
<p>​        iptables [-t table] -E old-chain-name new-chain-name<br>​<br>​        rule-specification = [matches…]  [target]</p>
<p>​        match = -m matchname [per-match-options]</p>
<p>​        target = -j targetname [per-target-options]<br>​<br>​        规则格式：iptables   [-t table]   COMMAND   chain   [-m matchname [per-match-options]]   -j targetname [per-target-options]<br>​<br>​            -t table：可省略，则默认filter功能表<br>​                raw, mangle, nat, [filter]<br>​                </p>
<h3 id="COMMAND："><a href="#COMMAND：" class="headerlink" title="COMMAND："></a>COMMAND：</h3><h3 id="链管理："><a href="#链管理：" class="headerlink" title="链管理："></a>链管理：</h3><p>​                    -N：new, 自定义一条新的规则链；<br>​                    -X： delete，删除自定义的规则链；<br>​                        注意：仅能删除 用户自定义的 引用计数为0的 空的 链；<br>​                    -P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：<br>​                        ACCEPT：接受<br>​                        DROP：丢弃<br>​                        REJECT：拒绝<br>​                    -E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除；</p>
<h3 id="规则管理："><a href="#规则管理：" class="headerlink" title="规则管理："></a>规则管理：</h3><p>​                    -A：append，追加；<br>​                    -I：insert, 插入，要指明位置，省略时表示第一条；<br>​                    -D：delete，删除；<br>​                        (1) 指明规则序号；<br>​                        (2) 指明规则本身；<br>​                    -R：replace，替换指定链上的指定规则；<br>​<br>​                    -F：flush，清空指定的规则链；<br>​                    -Z：zero，置零；<br>​                        iptables的每条规则都有两个计数器：<br>​                            (1) 匹配到的报文的个数；<br>​                            (2) 匹配到的所有报文的大小之和；<br>​                查看：<br>​                    -L：list, 列出指定鏈上的所有规则；<br>​                        -n：numberic，以数字格式显示地址和端口号；<code>因为iptables会将ip地址反解为主机名，性能会消耗，不利的，所以取消反解ip</code><br>​                        -v：verbose，<code>详细信息</code>；<br>​                            -vv, -vvv<br>​                        -x：exactly，显示计数器结果的精确值；<br>​                        –line-numbers：显示规则的序号；<br>​<br>​            chain：<br>​                PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING<br>​                </p>
<h3 id="匹配条件："><a href="#匹配条件：" class="headerlink" title="匹配条件："></a>匹配条件：</h3><p>​       基本匹配条件：PARAMETERS<br>​        扩展匹配条件：<br>​            隐式扩展：在使用-p选项指明了特定的协议时，无需再同时使用-m选项指明扩展模块的扩展机制；<br>​            显式扩展：必须使用-m选项指明要调用的扩展模块的扩展机制；</p>
<p>​                <code>基本匹配条件</code>：无需加载任何模块，由iptables/netfilter自行提供；</p>
<p>​                    [!] -s, –source  address[/mask][,…]：检查报文中的源IP地址是否符合此处指定的地址或范围；<br>​                    [!] -d, –destination address[/mask][,…]：检查报文中的目标IP地址是否符合此处指定的地址或范围；<br>​                        所有地址：0.0.0.0/0<br>​                    [!] -p, –protocol protocol<br>​                        protocol: tcp, udp, udplite, icmp, icmpv6,esp, ah, sctp, mh or  “all”<br>​                            {tcp|udp|icmp}<br>​                    [!] -i, –in-interface name：数据报文流入的接口；只能应用于数据报文流入的环节，只能应用于PREROUTING，INPUT和FORWARD链；<br>​                    [!] -o, –out-interface name：数据报文流出的接口；只能应用于数据报文流出的环节，只能应用于FORWARD、OUTPUT和POSTROUTING链；                                            </p>
<p>​                处理动作：<br>​                    -j targetname [per-target-options]<br>​                        ACCEPT<br>​                        DROP<br>​                        REJECT<br>​                        </p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>​               本机地址172.16.0.67<br>​            1、开放本机的所有tcp服务给所有主机；<br>​                # iptables -I INPUT  -d 172.16.0.67 -p tcp -j ACCEPT<br>​                # iptables -I OUTPUT  -s 172.16.0.67 -p tcp -j ACCEPT<br>​            2、开放本机的所有udp服务给172.16.0.0/16网络中的主机，但不包含172.16.0.200；<br>​                # iptables -I INPUT 2 -d 172.16.0.67 -s 172.16.0.200 -p udp -j REJECT<br>​                # iptables -I INPUT 3 -d 172.16.0.67 -s 172.16.0.0/16 -p udp -j ACCEPT<br>​                # iptables -I OUTPUT 2 -s 172.16.0.67 -d 172.16.0.0/16 -p udp -j ACCEPT<br>​            3、默认策略为REJECT；<br>​            扩展：<br>​            1、仅开放本机的ssh服务给172.16.0.0/16中的主机，而且不包含172.16.0.200; </p>
<p>​                    <code>隐式扩展</code>：不需要手动加载扩展模块；因为它们是对协议的扩展，所以，但凡使用-p指明了协议，就表示已经指明了要扩展的模块；<br>​                        tcp：<br>​                            [!] –source-port, –sport port[:port]：匹配报文的源端口；可以是端口范围；<br>​                            [!] –destination-port,–dport port[:port]：匹配报文的目标端口；可以是端口范围；<br>​                            [!] –tcp-flags  mask  comp<br>​                                    mask is the flags which we should examine,  written as a comma-separated list，例如 SYN,ACK,FIN,RST<br>​                                    comp is a comma-separated list  of  flags  which must be set，例如SYN<br>​                                    例如：“–tcp-flags  SYN,ACK,FIN,RST  SYN”表示，要检查的标志位为SYN,ACK,FIN,RST四个，其中SYN必须为1，余下的必须为0；<br>​                            [!] –syn：用于匹配第一次握手，相当于”–tcp-flags  SYN,ACK,FIN,RST  SYN“；<br>​                        udp<br>​                            [!] –source-port, –sport port[:port]：匹配报文的源端口；可以是端口范围；<br>​                            [!] –destination-port,–dport port[:port]：匹配报文的目标端口；可以是端口范围；<br>​<br>​                        icmp<br>​                            [!] –icmp-type {type[/code]|typename}<br>​                                    echo-request：8 发送icmp报文，ping请求<br>​                                    echo-reply：0   接受icmp报文，ping响应<br>​<br>​                    显式扩展：必须要手动加载扩展模块， [-m matchname [per-match-options]]；                     </p>
<p>​            <code>显式扩展</code>：必须使用-m选项指明要调用的扩展模块的扩展机制；<br>​                1、<code>multiport</code> 匹配散列端口<br>​                    This  module  matches  a  set  of  source  or  destination  ports. Up  to 15 ports can be specified.  A port range (port:port) counts as two ports.  It can only be used in conjunction with one of the following protocols: tcp,  udp, udplite, dccp and sctp.<br>​<br>​                    以离散或连续的 方式定义多端口匹配条件，最多15个；<br>​<br>​                    [!] –source-ports,–sports port[,port|,port:port]…：指定多个源端口；<br>​                    [!] –destination-ports,–dports port[,port|,port:port]…：指定多个目标端口；<br>​                    </p>
<p>iptables -I INPUT  -d 172.16.0.7 -p tcp -m multiport –dports 22,80,139,445,3306 -j ACCEPT</p>
<p>​            2、<code>iprange</code> 匹配连续地址<br>​                以连续地址块的方式来指明多IP地址匹配条件；<br>​                [!] –src-range from[-to]<br>​                [!] –dst-range from[-to]<br>​                </p>
<p>iptables -I INPUT -d 172.16.0.7 -p tcp -m multiport –dports 22,80,139,445,3306 -m iprange –src-range 172.16.0.61-172.16.0.70 -j REJECT</p>
<p>​            3、<code>time</code> 限制（匹配）时间<br>​                This  matches  if the packet arrival time/date is within a given range.<br>​<br>​                 –timestart hh:mm[:ss]<br>​                 –timestop hh:mm[:ss]<br>​<br>​                 [!] –weekdays day[,day…]<br>​<br>​                 [!] –monthdays day[,day…]<br>​<br>​                –datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]]<br>​                –datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]<br>​<br>​                 –kerneltz：使用内核配置的时区而非默认的UTC；<br>​<br>​            4、<code>string</code> 匹配报文字符串<br>​                This modules matches a given string by using some pattern matching strategy.<br>​<br>​                –algo {bm|kmp}<br>​                [!] –string pattern<br>​                [!] –hex-string pattern<br>​<br>​                –from offset<br>​                –to offset<br>​<br>​                ~]# iptables -I OUTPUT -m string –algo bm –string “gay” -j REJECT<br>​<br>​            5、<code>connlimit</code>  限制（匹配）同一个ip的并发连接数<br>​                Allows  you  to  restrict  the  number  of parallel connections to a server per client IP address (or client address block).<br>​<br>​                –connlimit-upto n  小于某个连接数量 ，一般搭配ACCEPT动作和黑名单默认策略<br>​                –connlimit-above n  大于某个连接数量 ，一般搭配REJIECTT动作和白名单默认策略<br>​<br>​                ~]# iptables -I INPUT -d 172.16.0.7 -p tcp –syn –dport 22 -m connlimit –connlimit-above 2 -j REJECT<br>​<br>​            6、<code>limit</code>  ：限制（匹配）发送报文的速度（而不是带宽的速度）。发送报文方要拿到令牌才有资格发送报文，而主动限制方是固定时间发令牌。这限制发送报文速率用的是令牌算法。限制方和被限制方协商好限制方一秒产生多少个令牌发送给被限制方，限制方有一个<code>令牌孔</code>，用来存放暂时不用的令牌（因为限制方一直发送令牌，被限制方不一定经常发送报文，既是某些令牌会多余出来，为了不扔了浪费，就用令牌孔来存放），制方可定义令牌孔的存放数量大小。因此被限制方积累了部分令牌，可能有一段时间超速。<br>​                This  module  matches  at  a limited rate using a token bucket filter.<br>​<br>​                –limit rate[/second|/minute|/hour|/day]<br>​                –limit-burst number 令牌孔最多收集多少个令牌<br>​<br>​                ~]# iptables -I OUTPUT -s 172.16.0.7 -p icmp –icmp-type 0 -j ACCEPT<br>​<br>​                限制本机某tcp服务接收新请求的速率：–syn, -m limit  既是接受够请求数量后，多余的放到阻塞队列中去<br>​<br>​            7、state<br>​                The “state” extension is a subset of the “conntrack” module.  “state” allows access to the connection tracking state for this packet.<br>​<br>​                [!] –state state<br>​                    INVALID, ESTABLISHED, NEW, RELATED or UNTRACKED.<br>​<br>​                    NEW: 新连接请求；<br>​                    ESTABLISHED：已建立的连接；<br>​                    INVALID：无法识别的连接；<br>​                    RELATED：相关联的连接，当前连接是一个新请求，但附属于某个已存在的连接；<br>​                    UNTRACKED：未追踪的连接；<br>​<br>​                    state扩展：<br>​                        内核模块装载：<br>​                            nf_conntrack<br>​                            nf_conntrack_ipv4<br>​<br>​                            手动装载：<br>​                                nf_conntrack_ftp<br>​<br>​                追踪到的连接：<br>​                    /proc/net/nf_conntrack<br>​<br>​                调整可记录的连接数量最大值：<br>​                    /proc/sys/net/nf_conntrack_max<br>​<br>​                超时时长：<br>​                    /proc/sys/net/netfilter/<em>timeout</em><br>​<br>处理动作（跳转目标）：<br>​    -j targetname [per-target-options]<br>​        简单target：<br>​            ACCEPT， DROP<br>​<br>​        扩展target：<br>​            REJECT<br>​                This is used to send back an error packet in response to the matched packet: otherwise it is equivalent to  DROP  so it  is  a  terminating  TARGET,  ending  rule traversal.<br>​<br>​                –reject-with type<br>​                    The type given can be icmp-net-unreachable, icmp-host-unreachable, icmp-port-unreachable, icmp-proto-unreach‐ able, icmp-net-prohibited, icmp-host-prohibited, or icmp-admin-prohibited (*), which return  the  appropriate ICMP  error  message (icmp-port-unreachable is the default).<br>​<br>​            LOG<br>​                Turn  on  kernel  logging of matching packets.<br>​<br>​                –log-level<br>​                –log-prefix<br>​<br>​                默认日志保存于/var/log/messages<br>​<br>​            RETURN：<br>​                返回调用者；<br>​<br>​        自定义链做为target：</p>
<p>​<br>​    保存和载入规则：<br>​        保存：iptables-save &gt; /PATH/TO/SOME_RULE_FILE<br>​        重载：iptabls-restore &lt; /PATH/FROM/SOME_RULE_FILE<br>​            -n, –noflush：不清除原有规则<br>​            -t, –test：仅分析生成规则集，但不提交<br>​<br>​        CentOS 6：<br>​            保存规则：<br>​                service iptables save<br>​                保存规则于/etc/sysconfig/iptables文件，覆盖保存；<br>​            重载规则：<br>​                service iptables restart<br>​                默认重载/etc/sysconfig/iptables文件中的规则<br>​<br>​            配置文件：/etc/sysconfig/iptables-config<br>​<br>​        CentOS 7：<br>​            (1) 自定义Unit File，进行iptables-restore；<br>​            (2) firewalld服务；<br>​            (3) 自定义脚本；<br>​<br>​    规则优化的思路：<br>​        使用自定义链管理特定应用的相关规则，模块化管理规则；<br>​<br>​        (1) 优先放行双方向状态为ESTABLISHED的报文；<br>​        (2) 服务于不同类别的功能的规则，匹配到报文可能性更大的放前面；<br>​        (3) 服务于同一类别的功能的规则，匹配条件较严格的放在前面；<br>​        (4) 设置默认策略：白名单机制<br>​            (a) iptables -P，不建议；<br>​            (b) 建议在规则的最后定义规则做为默认策略；</p>
<p>回顾：<br>    iptables/netfilter：<br>        netfilter：raw，mangle, nat, filter<br>            PREROUTING –&gt; INPUT<br>            PREROUTING –&gt; FORWARD –&gt; POSTROUTING<br>            OUTPUT –&gt; POSTROUTING<br>        filter：INPUT，FORWARD，OUTPUT<br>        nat：PREROUTING，INPUT，OUTPUT，POSTROUTING</p>
<pre><code>iptables：
    [-t table] COMMAND [chain] rule-specification
        -m matchname [per-match-options]
        -t targetname [per-target-options]
        [options]

    匹配 条件：
        基本匹配条件：-s, -d, -p, -m, -i, -o
        扩展匹配条件：
            隐式扩展：
                -p tcp: --dport, --sport, --tcp-flags, --syn 
                -p udp：--dport, --sport
                -p imcp: --icmp-type
            显式扩展：
                multiport：--sports, --dports
                iprange：--src-range, --dst-range
                time：--timestart, --timestop, --weekdays, --monthdays, --datestart, --datestop
                string：--algo {bm|kmp}, --string
                connlimit：--connlimit-upto, --connlimit-above
                limit：--limit, --limit-burst
                state：--state
                    NEW, ESTABLISHED, RELATED, INVALID, UNTRACKED

    target：
        -j：
            ACCEPT/DROP
            REJECT：--reject-with
            LOG：--log-level, --log-prefix
            自定义链
                RETURN

iptables-save/iptables-restore</code></pre><p>​<br>iptables（3）<br>​    iptables/netfilter网络防火墙：<br>​        (1) 网关；<br>​        (2) filter表的FORWARD链；<br>​<br>​        要注意的问题：<br>​            (1) 请求-响应报文均会经由FORWARD链，要注意规则的方向性；<br>​            (2) 如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行；<br>​<br>​        NAT: Network Address Translation<br>​            请求报文：由管理员定义；<br>​            响应报文：由NAT的conntrack机制自动实现；<br>​<br>​            请求报文：<br>​                改源地址：SNAT，MASQUERADE<br>​                改目标地址：DNAT<br>​<br>​        iptables/netfilter：<br>​            NAT定义在nat表；<br>​                PREROUTING，INPUT，OUTPUT，POSTROUTING<br>​<br>​                SNAT：POSTROUTING<br>​                DNAT：PREROUTING<br>​                PAT：<br>​<br>​        target：<br>​            SNAT：<br>​                This  target  is only valid in the nat table, in the POSTROUTING and INPUT chains, and user-defined chains which are only called from those chains.<br>​<br>                –to-source [ipaddr[-ipaddr]]</p>
<pre><code>    DNAT：
        This target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains  which  are only  called from those chains.

        --to-destination [ipaddr[-ipaddr]][:port[-port]]

     MASQUERADE
        This target is only valid in the nat table, in the POSTROUTING chain.  It  should  only  be  used  with  dynamically assigned  IP (dialup) connections: if you have a static IP address, you should use the SNAT target.

        SNAT场景中应用于POSTROUTING链上的规则实现源地址转换，但外网地址不固定时，使用此target；

    REDIRECT
        This  target  is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains.

        --to-ports port[-port]

layer7</code></pre><p>​<br>​<br>​    博客作业：iptables/netfilter入门到进阶</p>
<p>tcp_wrapper：</p>
<pre><code>库文件：libwrap.so，tcp包装器；

判断一个服务程序是否能够由tcp_wrapper进行访问控制的方法：
    (1) 动态链接至libwrap.so库；
        ldd  /PATH/TO/PROGRAM
            libwrap.so
    (2) 静态编译libwrap.so库文件至程序中：
        strings /PATH/TO/PGRGRAM 
            hosts_access

配置文件：/etc/hosts.allow, /etc/hosts.deny

     See &apos;man 5 hosts_options&apos; and &apos;man 5 hosts_access&apos; for information on rule syntax.    

    配置文件语法：
        daemon_list : client_list[ : option : option ...]

        daemon_list：程序文件名称列表
            (1) 单个应用程序文件名；
            (2) 程序文件名列表，以逗号分隔；
            (3) ALL：所有受tcp_wrapper控制的应用程序文件；

        client_list：
            (1) 单个IP地址或主机名；
            (2) 网络地址：n.n.n.n/m.m.m.m，n.n.n.；
            (3) 内建的ACL:
                ALL：所有客户端主机；
                LOCAL：Matches any host whose name does not contain a dot character.
                UNKNOWN
                KNOWN
                PARANOID

            OPERATORS：
                EXCEPT
                    list1 EXCEPT list2 EXCEPT list3

                    sshd: 172.16. EXCEPT 172.16.100. EXCEPT 172.16.100.68

        [ : option : option ...]

            deny：拒绝，主要用于hosts.allow文件中定义“拒绝”规则；
            allow：允许，主要用于hosts.deny文件中定义”允许“规则；

            spawn：生成，发起，触发执行用户指定的任意命令，此处通常用于记录日志；

                vsftpd: 172.16. : spawn /bin/echo $(date) login attempt from %c to %s &gt;&gt; /var/log/tcp_wrapper.log 

练习：仅开放本机的sshd服务给172.16.0.0/16网络中除了172.16.0.0/24网络中的主机之外的所有主机，但允许172.16.0.200访问； 每次的用户访问都要记录于日志文件中；</code></pre><p>​<br>​<br>​<br>​<br>​<br>​     </p>

      
    </div>
    
    
    

     <!-- 文章末尾统一添加“本文结束”标记 -->
    <div>
      
        <div>
    
        <div style="text-align:center;color: #555;font-size:24px;"><-------------The End-------------></div>
    
</div>

      
    </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创分享，你的支持就是我最大的动力！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/weixin_cash_code.png" alt="ashjian 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/alipay_cash_code.png" alt="ashjian 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/06-samba%E6%9C%8D%E5%8A%A1/" rel="next" title="06-samba服务">
                <i class="fa fa-chevron-left"></i> 06-samba服务
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/02-iptables%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/" rel="prev" title="02-iptables操作记录">
                02-iptables操作记录 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="ashjian" />
            
              <p class="site-author-name" itemprop="name">ashjian</p>
              <p class="site-description motion-element" itemprop="description">人类如风一般的自由</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">419</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
	   

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ashjian" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:13671474528@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/ashjian-ar15" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://me.csdn.net/ashjian" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-codiepie"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://mp.weixin.qq.com/user1" title="OpenInfo" target="_blank">OpenInfo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://mp.weixin.qq.com/user2" title="stormzhang" target="_blank">stormzhang</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables：-包过滤型的防火墙"><span class="nav-number">1.</span> <span class="nav-text">iptables： 包过滤型的防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables命令："><span class="nav-number">2.</span> <span class="nav-text">iptables命令：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#COMMAND："><span class="nav-number">2.1.</span> <span class="nav-text">COMMAND：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#链管理："><span class="nav-number">2.2.</span> <span class="nav-text">链管理：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#规则管理："><span class="nav-number">2.3.</span> <span class="nav-text">规则管理：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#匹配条件："><span class="nav-number">2.4.</span> <span class="nav-text">匹配条件：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习"><span class="nav-number">3.</span> <span class="nav-text">练习</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ashjian</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">本站总字数&#58;</span>
    
    <span title="本站总字数">363.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




#<!-- 百度自动推送 -->
#<script>
#(function(){
#    var bp = document.createElement('script');
#    var curProtocol = window.location.protocol.split(':')[0];
#    if (curProtocol === 'https') {
#        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
#    }
#    else {
#        bp.src = 'http://push.ashjian.baidu.com/push.js';
#    }
#    var s = document.getElementsByTagName("script")[0];
#    s.parentNode.insertBefore(bp, s);
#})();
#</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">

<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->

<script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script>
<div> 
<meting-js  
    server="netease" 
    type="playlist"  
    id="5281251057" 
    fixed="true"  
    autoplay="false" 
    loop="all" 
    order="random"
    preload="auto" 
    list-folded="ture" 
    list-max-height="500px" 
    lrc-type="1">
</meting-js>	 
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Gp5xxuBGmRxC9yeJHf5wlLpN-gzGzoHsz',
        appKey: 'wo0eDJonJrnuUrCCCU7EnH1n',
        placeholder: '欢迎评论',
        avatar:'mm',
        guest_info:guest,
        pageSize:'20' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/pa15.model.json"},"display":{"position":"right","width":500,"height":500,"hOffset":-150,"vOffset":-100},"mobile":{"show":true,"scale":0.7},"log":false});</script></body>
</html>
